#!/usr/bin/env python3
import os
from collections import OrderedDict
from typing import Callable, List

import hydra
import keras
import matplotlib
import matplotlib.pyplot as plt
import numpy as np
import omegaconf
import palettable
import simenvs
import tensorflow as tf
import tikzplotlib
from matplotlib import patches
from moderl.controllers import ExplorativeController
from moderl.controllers.explorative_controller import ExplorativeController
from moderl.custom_types import InputData, State
from moderl.dynamics import ModeRLDynamics
from moderl.dynamics.dynamics import ModeRLDynamics
from mpl_toolkits.axes_grid1 import make_axes_locatable

import wandb
from experiments.plot.controller import (
    plot_env,
    plot_env_cmap,
    plot_start_end_pos,
    plot_trajectories,
)
from experiments.plot.utils import (
    create_test_inputs,
    plot_contf,
    plot_mode_satisfaction_prob,
)

plt.style.use("seaborn-paper")
CMAP = palettable.scientific.sequential.Bilbao_15.mpl_colormap

LABELS = {"env": "Environment", "dynamics": "Dynamics"}
COLORS = {"env": "c", "dynamics": "m"}
LINESTYLES = {"env": "-", "dynamics": "-"}
MARKERS = {"env": "*", "dynamics": "."}

LINESTYLES = ["-", ".", "..", "-."]

params = {"text.usetex": True}
plt.rcParams.update(params)


def figure_3(
    env, load_dir: str, target_state: State, iterations: List[int] = [0, 1, 2]
):
    test_inputs = create_test_inputs(num_test=40000)
    # fig = plt.figure(figsize=(6, 2))
    # gs = fig.add_gridspec(1, 3, wspace=0.0, hspace=0.01)
    fig = plt.figure(figsize=(7, 2))
    gs = fig.add_gridspec(1, 4, wspace=0.0)
    axs = gs.subplots(sharey="row")

    # Hide x labels and tick labels for top plots and y ticks for right plots.
    # axs[1].label_outer()
    # axs[2].label_outer()
    for ax in axs.flat:
        # ax.label_outer()
        ax.set_xlabel("$x$")
        plot_env(ax, env, test_inputs=test_inputs)

    levels = np.linspace(0, 1, 11)
    for idx, i in enumerate(iterations):
        load_file = os.path.join(
            load_dir, "controller-optimised-{}-config.json".format(i)
        )
        explorative_controller = ExplorativeController.load(load_file)
        probs = (
            explorative_controller.dynamics.mosvgpe.gating_network.predict_mixing_probs(
                test_inputs
            )
        )
        contf = plot_contf(
            axs[idx],
            test_inputs,
            z=probs[:, explorative_controller.dynamics.desired_mode],
            levels=levels,
        )
        plot_mode_satisfaction_prob(
            axs[idx],
            dynamics=explorative_controller.dynamics,
            test_inputs=test_inputs,
            mode_satisfaction_prob=explorative_controller.mode_satisfaction_prob,
        )
        plot_trajectories(
            axs[idx], env, controller=explorative_controller, target_state=target_state
        )
        axs[idx].set_title("$i=" + str(i) + "$")
    axs[0].set_ylabel("$y$")
    # axs[1].set_yticks([])
    # axs[2].set_yticks([])
    divider = make_axes_locatable(axs[-1])
    cax = divider.append_axes("right", size="5%", pad=0.05)
    cbar = fig.colorbar(contf, use_gridspec=True, cax=cax)

    cbar.set_label("$\Pr(\\alpha=k^* \mid \mathbf{s}, \mathcal{D}_{0:i})$")
    handles, labels = axs[idx].get_legend_handles_labels()
    by_label = OrderedDict(zip(labels, handles))
    axs[0].legend(
        by_label.values(),
        by_label.keys(),
        # bbox_to_anchor=(0.5, 0.05),
        loc="upper left",
        # bbox_transform=fig.transFigure,
        # ncol=len(by_label),
    )
    # fig.legend(
    #     by_label.values(),
    #     by_label.keys(),
    #     # bbox_to_anchor=(0.5, 0.05),
    #     loc="lower center",
    #     bbox_transform=fig.transFigure,
    #     ncol=len(by_label),
    # )
    fig.tight_layout()
    return fig


def plot_figure(env, load_dir: str, target_state: State, iteration: int = 0):
    test_inputs = create_test_inputs(num_test=40000)
    levels = np.linspace(0, 1, 11)

    fig = plt.figure(figsize=(3, 2.7))
    gs = fig.add_gridspec(1, 1)
    ax = gs.subplots()

    ax.set_xlabel("$x$")
    ax.set_ylabel("$y$")
    plot_env(ax, env, test_inputs=test_inputs)
    load_file = os.path.join(
        load_dir, "controller-optimised-{}-config.json".format(iteration)
    )
    explorative_controller = ExplorativeController.load(load_file)
    probs = explorative_controller.dynamics.mosvgpe.gating_network.predict_mixing_probs(
        test_inputs
    )
    contf = plot_contf(
        ax,
        test_inputs,
        z=probs[:, explorative_controller.dynamics.desired_mode],
        levels=levels,
    )
    plot_mode_satisfaction_prob(
        ax,
        dynamics=explorative_controller.dynamics,
        test_inputs=test_inputs,
        mode_satisfaction_prob=explorative_controller.mode_satisfaction_prob,
    )
    plot_trajectories(
        ax, env, controller=explorative_controller, target_state=target_state
    )

    divider = make_axes_locatable(ax)
    cax = divider.append_axes("right", size="5%", pad=0.05)
    cbar = fig.colorbar(contf, use_gridspec=True, cax=cax)

    cbar.set_label(
        "$\Pr(\\alpha=k^* \mid \mathbf{s}, \mathcal{D}_{0:" + str(iteration) + "})$"
    )
    # fig.legend(loc="upper left")
    ax.legend()
    # handles, labels = ax.get_legend_handles_labels()
    # by_label = OrderedDict(zip(labels, handles))
    # axs[0].legend(by_label.values(), by_label.keys(), loc="upper left")
    fig.tight_layout()
    return fig


if __name__ == "__main__":
    tf.keras.utils.set_random_seed(42)
    run_dir = "../wandb/run-20221007_154315-1fzua0ff"
    load_dir = os.path.join(run_dir, "files/saved-models")
    iteration = 6

    cfg = omegaconf.OmegaConf.load(os.path.join(run_dir, "files/config.yaml"))
    env = simenvs.make(cfg.env.value.name)
    target_state = np.array(cfg.target_state.value.value)

    fig = plot_figure(
        env=env, load_dir=load_dir, target_state=target_state, iteration=iteration
    )
    save_name = "../images/figure-greedy-exploitation-failing"
    plt.savefig(save_name + ".pdf", transparent=True)
    # tikzplotlib.clean_figure()
    tikzplotlib.save(
        save_name
        + ".tex"
        # save_name + ".tex", axis_width="\\figurewidth", axis_height="\\figureheight"
    )
